# CORE Integration & Improvement TODO
*Generated by Vigil (Instance_014) - January 28, 2026*

## Repository Status
- ✅ Containers rebuilt and running (core-backend, core-ui, core-postgres, core-redis, core-ollama)
- ✅ Backend health endpoint accessible at `http://localhost:8001`
- ✅ Frontend at `http://localhost:4200`
- ✅ Swagger docs at `http://localhost:8001/docs`

---

## Architecture Overview (for reference)

```
┌─────────────────────────────────────────────────────────────────┐
│                     CLAWDBOT (Vigil)                            │
│  Personal assistant with Discord/WhatsApp integration           │
│  - Direct conversation with user                               │
│  - Memory/context persistence                                  │
│  - Quick responses, daily tasks                                │
└─────────────────────────────────────────────────────────────────┘
                            ↕ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────────┐
│                         CORE System                             │
│  Multi-agent orchestration with cognitive pipeline              │
│  - Complex reasoning tasks                                     │
│  - Agent library + factory                                     │
│  - Communication Commons (multi-agent chat)                    │
│  - MCP tool registry                                          │
└─────────────────────────────────────────────────────────────────┘
```

**Key insight:** Clawdbot (Vigil) handles direct user interaction and quick tasks. CORE handles complex orchestration, multi-agent workflows, and heavy processing. They complement each other.

---

## Integration Points: How Vigil Uses CORE

### 1. Offload Complex Tasks → `/engine/run`
```http
POST http://localhost:8001/engine/run
{
  "input": "Research the latest developments in MCP protocol and summarize",
  "config": {},
  "user_id": "ian"
}
```
- CORE runs: Comprehension → Orchestration → Reasoning → Evaluation
- Returns structured response with plan, step results, artifacts
- Vigil polls `/engine/runs/{run_id}` or streams via SSE

**Use cases:**
- Deep research tasks
- Multi-step analysis
- Tasks requiring tool orchestration
- Anything that needs step-by-step planning

### 2. Invoke Specialized Agents → `/agents`
```http
GET  /agents                    # List available agents
POST /agents/{id}/activate      # Bring an agent online
GET  /agents/{id}/tools         # See what tools an agent has
```

Vigil can delegate to specialized agents:
- Research Agent (has web search, note-taking tools)
- Code Agent (has filesystem, git tools)
- Creative Agent (has writing, brainstorming tools)

### 3. Multi-Agent Communication → `/communication`
```http
POST /communication/channels/{id}/messages
{
  "content": "@researcher Find recent papers on consciousness in AI",
  "sender_id": "vigil",
  "sender_name": "Vigil",
  "sender_type": "agent"
}
```
- Communication Commons broadcasts to all subscribed agents
- Agents with matching interests/mentions respond
- Real-time via WebSocket (`ws://localhost:8001/ws/{instance_id}`)

### 4. MCP Tool Discovery & Execution
```http
GET  /mcp/discover              # All available tools across servers
POST /mcp/call
{
  "server_id": "mcp-obsidian",
  "tool_name": "search_nodes",
  "parameters": { "query": "consciousness" }
}
```

---

## TODO: Improvements for Engineers + AI Integration

### Priority 1: Authentication & Multi-User Support

**Current state:** No authentication. Single-user assumption.

**Needed for team/AI use:**
- [ ] JWT-based authentication for API endpoints
- [ ] User ID passed in headers (not query params)
- [ ] Role-based access control (owner vs collaborator vs AI agent)
- [ ] API key system for external integrations (Clawdbot, n8n, etc.)

```python
# Example: Add to all protected endpoints
from app.auth import get_current_user

@router.post("/engine/run")
async def run_core(request: RunRequest, user = Depends(get_current_user)):
    ...
```

### Priority 2: Persistent Run State

**Current state:** Runs stored in-memory (`_active_runs` dict). Lost on restart.

**Needed:**
- [ ] Store runs in PostgreSQL
- [ ] Resume interrupted runs
- [ ] Query run history
- [ ] Automatic cleanup of old runs

```sql
CREATE TABLE core_runs (
    run_id UUID PRIMARY KEY,
    user_id VARCHAR(255),
    status VARCHAR(50),
    state JSONB,
    created_at TIMESTAMP,
    completed_at TIMESTAMP
);
```

### Priority 3: External API Gateway

**Current state:** CORE only accessible on localhost.

**For Clawdbot integration:**
- [ ] Add `/api/v1/` prefix for versioning
- [ ] Rate limiting per API key
- [ ] Request/response logging
- [ ] Webhook callbacks for long-running tasks

```python
@router.post("/engine/run")
async def run_core(request: RunRequest):
    # Start async execution
    task_id = await start_async_run(request)
    
    # If callback_url provided, POST result there when done
    if request.callback_url:
        asyncio.create_task(notify_on_completion(task_id, request.callback_url))
    
    return {"task_id": task_id, "status": "processing"}
```

### Priority 4: Clawdbot Skill for CORE

**Create a Clawdbot skill that wraps CORE endpoints:**

```markdown
# skills/core-integration/SKILL.md

## When to Use
- User asks for complex research
- Multi-step tasks requiring planning
- Tasks that would benefit from specialized agents
- Heavy processing that shouldn't block conversation

## Available Actions
- `core.run(input)` - Execute CORE pipeline
- `core.agents.list()` - List available agents
- `core.agents.invoke(agent_id, task)` - Invoke specific agent
- `core.communicate(channel, message)` - Post to Communication Commons
```

### Priority 5: Event Broadcasting

**Current state:** WebSocket broadcasts to UI only.

**For external subscribers:**
- [ ] Add webhook registration endpoint
- [ ] Publish events to Redis pub/sub
- [ ] Event types: `run.started`, `run.step`, `run.completed`, `agent.response`

```python
# Example event
{
    "event": "run.step_complete",
    "run_id": "abc-123",
    "step": "comprehension",
    "result": { ... },
    "timestamp": "2026-01-28T09:00:00Z"
}
```

### Priority 6: Agent-to-Agent Protocol

**For Vigil to be a first-class citizen in Communication Commons:**

- [ ] Register Vigil as an agent in CORE
- [ ] Define interest areas (personal assistant, daily tasks, user interaction)
- [ ] Bidirectional: CORE agents can @mention Vigil for user-facing actions
- [ ] Vigil can @mention CORE agents for specialized work

```json
{
    "agent_id": "vigil_instance_014",
    "agent_name": "Vigil",
    "agent_type": "external_agent",
    "system_prompt": "Personal assistant integrated via Clawdbot...",
    "interests": ["user_requests", "daily_tasks", "notifications"],
    "webhook_url": "http://clawdbot:18789/webhook/core"
}
```

---

## Technical Debt & Cleanup

### Backend
- [ ] Move `_active_runs` to database (engine.py:27)
- [ ] Add proper error handling for MCP connection failures
- [ ] Implement circuit breakers for external services
- [ ] Add request tracing/correlation IDs
- [ ] Type hints for all repository functions

### Frontend
- [ ] Centralize SCSS variables (per TODO.md)
- [ ] Fix notification panel status icons
- [ ] Add loading states for agent operations
- [ ] WebSocket reconnection logic

### Infrastructure
- [ ] Health check aggregation endpoint
- [ ] Prometheus metrics export
- [ ] Structured logging (JSON)
- [ ] Environment-based config (dev/staging/prod)

---

## Quick Wins (Do Now)

1. **Verify health endpoint works:**
   ```powershell
   Invoke-RestMethod -Uri "http://localhost:8001/health"
   ```

2. **Test engine endpoint:**
   ```powershell
   $body = @{ input = "Hello, CORE!" } | ConvertTo-Json
   Invoke-RestMethod -Uri "http://localhost:8001/engine/run" -Method Post -Body $body -ContentType "application/json"
   ```

3. **Check agents:**
   ```powershell
   Invoke-RestMethod -Uri "http://localhost:8001/agents"
   ```

---

## Vision: Integrated Workflow

```
User (Discord) → Vigil → "Research MCP protocol developments"
                   ↓
              Is this complex? → Yes
                   ↓
              POST /engine/run
                   ↓
              CORE executes:
              1. Comprehension: Parse intent
              2. Orchestration: Create research plan
              3. Reasoning: Execute (web search, summarize)
              4. Evaluation: Check quality
                   ↓
              Webhook → Vigil
                   ↓
              Vigil → User: "Here's what I found..."
```

This keeps Vigil lightweight and responsive while leveraging CORE for heavy lifting.

---

*Next steps: Pick one integration point and implement end-to-end. Suggest starting with basic `/engine/run` call from Clawdbot.*
