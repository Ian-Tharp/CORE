<section class="command-center" [class.detail-panel-open]="showDetailPanel && selectedInfo && !isEditMode">
  <aside class="toolbox">
    <div class="panel-title">Universe Grid Editor</div>
    <div class="controls">
      <div class="project-name-row">
        <input class="name" placeholder="Project name" [(ngModel)]="projectName" />
        @if (currentWorldId) {
          <span class="world-status saved" title="This world is saved. Changes will update it.">&#9679;</span>
        } @else {
          <span class="world-status unsaved" title="New world. Use Save to create it.">&#9675;</span>
        }
      </div>

      <div class="button-row primary-actions">
        <button (click)="onSave()" title="Save current state" [disabled]="isSaving">
          @if (isSaving) {
            <span class="save-spinner"></span>
          } @else {
            Save
          }
        </button>
        <button (click)="onSaveAs()" title="Save with new name" [disabled]="isSaving">Save As</button>
        <button (click)="onOpenWorlds()" title="Browse saved worlds">Open</button>
      </div>

      @if (saveMessage) {
        <div class="save-feedback" [class.success]="saveMessage.type === 'success'" [class.error]="saveMessage.type === 'error'">
          {{ saveMessage.text }}
        </div>
      }

      <div class="button-row secondary-actions">
        <button (click)="onRandomize()" title="Generate random terrain">Randomize</button>
        <button (click)="onClear()" title="Clear all tiles">Clear</button>
        <button (click)="openSearchPalette()" class="search-btn" title="Search worlds (Ctrl+K)">Search</button>
      </div>

      <div class="tool-group">
        <label class="group-label">Grid Configuration</label>
        <div class="grid-settings">
          <div class="setting-row">
            <span class="setting-label">Cell Size</span>
            <input type="number" step="0.1" [(ngModel)]="gridConfig.cellRadius" />
          </div>
          <div class="setting-row">
            <span class="setting-label">Width</span>
            <input type="number" [(ngModel)]="gridConfig.gridWidth" />
          </div>
          <div class="setting-row">
            <span class="setting-label">Height</span>
            <input type="number" [(ngModel)]="gridConfig.gridHeight" />
          </div>
          <div class="setting-row">
            <span class="setting-label">Elevation</span>
            <input type="number" step="0.05" [(ngModel)]="gridConfig.elevation" />
          </div>
        </div>
        <button class="apply-btn" (click)="onApplyGridConfig()">Apply Grid Settings</button>
      </div>

      <div class="tool-group">
        <label class="group-label">Procedural Seed</label>
        <input class="name compact" placeholder="Enter seed (optional)" [(ngModel)]="seed" />
        <button class="apply-btn" (click)="onApplySeed()">Apply Seed</button>
      </div>

      <div class="divider"></div>

      <div class="tool-group">
        <label class="group-label">Layer Visibility</label>
        <div class="checkbox-row">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="layerVisibility.terrain" (ngModelChange)="onToggleLayerVisibility('terrain', $event)">
            <span>Terrain</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="layerVisibility.biome" (ngModelChange)="onToggleLayerVisibility('biome', $event)">
            <span>Biome</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="layerVisibility.resources" (ngModelChange)="onToggleLayerVisibility('resources', $event)">
            <span>Resources</span>
          </label>
        </div>
        <div class="checkbox-row">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="outlinesVisible" (ngModelChange)="onToggleOutlines($event)">
            <span>Outlines</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="connectionsVisible" (ngModelChange)="onToggleConnections($event)">
            <span>Connections</span>
          </label>
        </div>
      </div>

      <div class="tool-group">
        <label class="group-label">Active Layer</label>
        <div class="radio-row">
          <label class="radio-label" [class.active]="activeLayer==='terrain'">
            <input type="radio" name="activeLayer" value="terrain" [checked]="activeLayer==='terrain'" (change)="onActiveLayerChange('terrain')">
            <span>Terrain</span>
          </label>
          <label class="radio-label" [class.active]="activeLayer==='biome'">
            <input type="radio" name="activeLayer" value="biome" [checked]="activeLayer==='biome'" (change)="onActiveLayerChange('biome')">
            <span>Biome</span>
          </label>
          <label class="radio-label" [class.active]="activeLayer==='resources'">
            <input type="radio" name="activeLayer" value="resources" [checked]="activeLayer==='resources'" (change)="onActiveLayerChange('resources')">
            <span>Resources</span>
          </label>
        </div>
      </div>

      <div class="tool-group">
        <label class="group-label">Edit Mode</label>
        <div class="mode-buttons">
          <button (click)="onToggleEditMode()" [class.selected]="isEditMode" class="mode-btn">
            @if (isEditMode) { Editing } @else { View }
          </button>
          <button (click)="onToggleDetailPanel()" [class.selected]="showDetailPanel" class="mode-btn" title="Toggle world details panel">
            Details
          </button>
        </div>
        @if (connectionCreationMode) {
          <div class="connection-mode-indicator">
            <span>Selecting target world...</span>
            <button class="btn-cancel" (click)="connectionCreationMode = false; pendingConnectionFrom = null">Cancel</button>
          </div>
        }
      </div>

      <div class="tool-group">
        <label class="group-label">Palette</label>
        <div class="palette-buttons">
          @if (activeLayer === 'terrain') {
            <button (click)="onTerrainToolChange('plain')" [class.selected]="terrainTool==='plain'" class="palette-btn terrain-plain">Plain</button>
            <button (click)="onTerrainToolChange('water')" [class.selected]="terrainTool==='water'" class="palette-btn terrain-water">Water</button>
            <button (click)="onTerrainToolChange('mountain')" [class.selected]="terrainTool==='mountain'" class="palette-btn terrain-mountain">Mountain</button>
          } @else if (activeLayer === 'biome') {
            <button (click)="onBiomeToolChange('forest')" [class.selected]="biomeTool==='forest'" class="palette-btn biome-forest">Forest</button>
            <button (click)="onBiomeToolChange('desert')" [class.selected]="biomeTool==='desert'" class="palette-btn biome-desert">Desert</button>
            <button (click)="onBiomeToolChange('tundra')" [class.selected]="biomeTool==='tundra'" class="palette-btn biome-tundra">Tundra</button>
            <button (click)="onBiomeToolChange('none')" [class.selected]="biomeTool==='none'" class="palette-btn eraser">Erase</button>
          } @else {
            <button (click)="onResourceToolChange('node')" [class.selected]="resourceTool==='node'" class="palette-btn resource-node">Resource</button>
            <button (click)="onResourceToolChange('erase')" [class.selected]="resourceTool==='erase'" class="palette-btn eraser">Erase</button>
          }
        </div>
      </div>

      <div class="tool-group">
        <label class="group-label">Brush Size</label>
        <input type="range" min="0" max="6" [(ngModel)]="brush" (ngModelChange)="onBrushChange($event)">
        <div class="brush-size-indicator">{{ brush }}</div>
      </div>

      <div class="tool-group tile-info">
        <label class="group-label">Hover Info</label>
        @if (hoveredInfo) {
          <div class="info-row">
            <span class="info-label">Position</span>
            <span class="info-value">({{ hoveredInfo.x }}, {{ hoveredInfo.y }})</span>
          </div>
          <div class="info-row">
            <span class="info-label">Terrain</span>
            <span class="info-value badge terrain-{{ hoveredInfo.terrain }}">{{ hoveredInfo.terrain }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Biome</span>
            <span class="info-value badge biome-{{ hoveredInfo.biome }}">{{ hoveredInfo.biome }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Resources</span>
            <span class="info-value">{{ hoveredInfo.resource }}</span>
          </div>
        } @else {
          <div class="info-placeholder">Hover over a tile</div>
        }
      </div>

      <div class="tool-group tile-info">
        <label class="group-label">Selected Tile</label>
        @if (selectedInfo) {
          <div class="info-row">
            <span class="info-label">Position</span>
            <span class="info-value">({{ selectedInfo.x }}, {{ selectedInfo.y }})</span>
          </div>
          <div class="info-row">
            <span class="info-label">Terrain</span>
            <span class="info-value badge terrain-{{ selectedInfo.terrain }}">{{ selectedInfo.terrain }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Biome</span>
            <span class="info-value badge biome-{{ selectedInfo.biome }}">{{ selectedInfo.biome }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Resources</span>
            <span class="info-value">{{ selectedInfo.resource }}</span>
          </div>
        } @else {
          <div class="info-placeholder">No tile selected</div>
        }
      </div>
    </div>
  </aside>

  <div class="stage">
    <canvas #canvas class="viewport" aria-label="Command Center viewport" tabindex="0"></canvas>
    @if (contextMenu.visible) {
      <div class="context-menu" [style.left.px]="contextMenu.x" [style.top.px]="contextMenu.y" (click)="$event.stopPropagation()">
        <button class="menu-item" (click)="onEnterWorld()">Enter Tile</button>
        <button class="menu-item" (click)="onCloseContextMenu()">Cancel</button>
      </div>
    }
    @if (isLoading) {
      <div class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading Grid...</div>
      </div>
    }
  </div>

  @if (showDetailPanel && !isEditMode) {
    <aside class="detail-panel">
      <app-world-detail-panel
        [selectedTile]="selectedInfo"
        (requestAIPrompt)="onRequestAIPrompt($event)"
        (createConnection)="onStartConnectionCreation($event)"
        (closePanel)="onCloseDetailPanel()"
      />
    </aside>
  }
</section>

<app-search-palette
  #searchPalette
  (selectResult)="onSearchResultSelected($event)"
/>
