<div class="my-agents">
  <header class="page-head">
    <div class="titles">
      <h1>
        <mat-icon class="title-icon">folder_shared</mat-icon>
        My Agents
      </h1>
      <div class="counts">{{ enabledCount }} enabled · {{ totalCount }} total</div>
    </div>
    <div class="actions">
      <a mat-raised-button color="primary" routerLink="/agents">
        <mat-icon>add</mat-icon>
        New Agent
      </a>
      <a mat-stroked-button routerLink="/agents/marketplace">
        <mat-icon>hub</mat-icon>
        Marketplace
      </a>
      <button mat-stroked-button>
        <mat-icon>file_upload</mat-icon>
        Import
      </button>
      <button mat-stroked-button>
        <mat-icon>archive</mat-icon>
        Export All
      </button>
      <mat-button-toggle-group [value]="view" (valueChange)="view = $event">
        <mat-button-toggle value="grid" aria-label="Grid view"><mat-icon>grid_view</mat-icon></mat-button-toggle>
        <mat-button-toggle value="list" aria-label="List view"><mat-icon>view_list</mat-icon></mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  </header>

  <app-agent-filter-bar (filterChanged)="onFilterChanged($event)" (sortChanged)="onSortChanged($event)"></app-agent-filter-bar>

  @if (currentFilter.tags?.length || currentFilter.favoritesOnly || currentFilter.enabledOnly || currentFilter.draftsOnly || currentFilter.recentlyUsed) {
    <div class="active-tags">
      <mat-chip-set aria-label="Active filters">
        @for (t of currentFilter.tags ?? []; track t) {
          <mat-chip (removed)="removeTag(t)">
            {{ t }}
            <button matChipRemove aria-label="Remove tag filter"><mat-icon>close</mat-icon></button>
          </mat-chip>
        }
        @if (currentFilter.favoritesOnly) {
          <mat-chip (removed)="removeFavoriteFilter()">
            <mat-icon>favorite</mat-icon> Favorites
            <button matChipRemove aria-label="Remove favorites filter"><mat-icon>close</mat-icon></button>
          </mat-chip>
        }
        @if (currentFilter.enabledOnly) {
          <mat-chip (removed)="removeEnabledFilter()">
            <mat-icon>toggle_on</mat-icon> Enabled
            <button matChipRemove aria-label="Remove enabled filter"><mat-icon>close</mat-icon></button>
          </mat-chip>
        }
        @if (currentFilter.draftsOnly) {
          <mat-chip (removed)="removeDraftsFilter()">
            <mat-icon>drafts</mat-icon> Drafts
            <button matChipRemove aria-label="Remove drafts filter"><mat-icon>close</mat-icon></button>
          </mat-chip>
        }
        @if (currentFilter.recentlyUsed) {
          <mat-chip (removed)="removeRecentFilter()">
            <mat-icon>schedule</mat-icon> Recently used
            <button matChipRemove aria-label="Remove recently used filter"><mat-icon>close</mat-icon></button>
          </mat-chip>
        }
      </mat-chip-set>
    </div>
  }

  <main class="content">
    <ng-container *ngIf="agents$ | async as agents; else loading">
      @if (agents.length > 0) {
        <app-agent-grid
          [view]="view"
          [agents]="agents"
          (select)="onSelect($event)"
          (favoriteToggled)="onFavorite($event)"
          (enabledToggled)="onEnabled($event)"
          (duplicateClicked)="onDuplicate($event)"
          (deleteClicked)="onDelete($event)"
          (exportClicked)="onExport($event)"
          (tagClicked)="onTagFilter($event)"
        />
      } @else {
        <div class="empty">
          <mat-icon>search_off</mat-icon>
          <h3>No agents found</h3>
          <p>Try clearing filters or visit the Marketplace to add agents.</p>
          <div class="cta">
            <a mat-raised-button color="primary" routerLink="/agents/marketplace"><mat-icon>hub</mat-icon> Go to Marketplace</a>
            <a mat-stroked-button routerLink="/agents"><mat-icon>add</mat-icon> Create Agent</a>
          </div>
        </div>
      }
    </ng-container>
    <ng-template #loading>
      <div class="loading"><mat-icon class="spin">autorenew</mat-icon> Loading your agents…</div>
    </ng-template>
  </main>

  <app-agent-detail-drawer
    [open]="!!selected"
    [agent]="selected"
    (closed)="onCloseDetails()"
    (enableToggled)="onEnabled($event)"
    (duplicateClicked)="onDuplicate($event)"
    (deleteClicked)="onDelete($event)"
    (exportClicked)="onExport($event)"
  />
</div>
